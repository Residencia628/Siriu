# Google Cloud Platform Deployment Guide

## Prerequisites

1. **Google Cloud SDK**
   - Download: https://cloud.google.com/sdk/docs/install
   - Install and run: `gcloud init`

2. **Firebase CLI**
   ```bash
   npm install -g firebase-tools
   ```

3. **GCP Project**
   - Create project: https://console.cloud.google.com/
   - Enable billing

4. **Docker** (optional, for local testing)
   - Download: https://www.docker.com/products/docker-desktop

---

## Quick Start

### Option 1: Automated Setup (Recommended)

```batch
# Step 1: Setup GCP environment
setup-gcp.bat

# Step 2: Deploy application
deploy-gcp.bat
```

### Option 2: Manual Setup

#### 1. Install Google Cloud SDK
```batch
# Verify installation
gcloud --version

# Login
gcloud auth login

# Set project
gcloud config set project YOUR_PROJECT_ID
```

#### 2. Enable Required APIs
```batch
gcloud services enable run.googleapis.com
gcloud services enable cloudbuild.googleapis.com
gcloud services enable firestore.googleapis.com
gcloud services enable firebase.googleapis.com
```

#### 3. Initialize Firestore
- Go to: https://console.cloud.google.com/firestore
- Select "Native Mode"
- Choose region: `us-central1`
- Click "Create Database"

#### 4. Deploy Backend to Cloud Run
```batch
cd backend

# Build and deploy
gcloud builds submit --tag gcr.io/YOUR_PROJECT_ID/inventory-backend

gcloud run deploy inventory-backend \
  --image gcr.io/YOUR_PROJECT_ID/inventory-backend \
  --platform managed \
  --region us-central1 \
  --allow-unauthenticated \
  --set-env-vars USE_FIRESTORE=true,GCP_PROJECT_ID=YOUR_PROJECT_ID
```

#### 5. Deploy Frontend to Firebase Hosting
```batch
cd frontend

# Login to Firebase
firebase login

# Initialize Firebase
firebase init hosting
# - Select your project
# - Public directory: build
# - Single-page app: Yes
# - Overwrites: No

# Build React app
npm run build

# Deploy
firebase deploy
```

---

## Environment Variables

### Backend (Cloud Run)
Set via Cloud Console or command line:

```bash
USE_FIRESTORE=true
GCP_PROJECT_ID=your-project-id
JWT_SECRET_KEY=your-secure-secret-key
CORS_ORIGINS=https://your-frontend-url.web.app
```

### Frontend (.env.production)
```env
REACT_APP_BACKEND_URL=https://your-backend-url.run.app
```

---

## Cost Estimates

### Free Tier (sufficient for testing/small apps):
- **Cloud Run**: 2 million requests/month
- **Firestore**: 1GB storage, 50K reads, 20K writes/day
- **Firebase Hosting**: 10GB storage, 360MB/day transfer

### Expected monthly costs for moderate use:
- Cloud Run: $0-5
- Firestore: $0-10
- Firebase Hosting: $0

---

## Testing Locally with Firestore Emulator

```batch
# Install Firebase emulator
firebase init emulators

# Start emulator
firebase emulators:start

# Run backend with emulator
cd backend
set FIRESTORE_EMULATOR_HOST=localhost:8080
set USE_FIRESTORE=true
uvicorn server:app --reload
```

---

## Monitoring & Logs

### View Cloud Run Logs
```bash
gcloud run logs read inventory-backend --region us-central1
```

### View in Console
- Cloud Run: https://console.cloud.google.com/run
- Firestore: https://console.cloud.google.com/firestore
- Firebase: https://console.firebase.google.com

---

## Security Best Practices

1. **Enable Authentication** (future enhancement):
   ```bash
   gcloud run services update inventory-backend \
     --no-allow-unauthenticated
   ```

2. **Use Secret Manager** for sensitive data:
   ```bash
   echo -n "your-secret-key" | gcloud secrets create jwt-secret --data-file=-
   ```

3. **Configure Firestore Security Rules**:
   ```javascript
   rules_version = '2';
   service cloud.firestore {
     match /databases/{database}/documents {
       match /{document=**} {
         allow read, write: if request.auth != null;
       }
     }
   }
   ```

---

## Troubleshooting

### Issue: Cloud Build fails
- Check Docker syntax: `docker build -t test .`
- Verify requirements.txt is complete

### Issue: Cloud Run deployment fails
- Check logs: `gcloud run logs read inventory-backend`
- Verify environment variables are set

### Issue: Frontend can't connect to backend
- Check CORS settings in backend
- Verify REACT_APP_BACKEND_URL is correct
- Check Cloud Run allows unauthenticated requests

### Issue: Firestore connection fails
- Verify Firestore is initialized
- Check GCP_PROJECT_ID is correct
- Ensure service account has Firestore permissions

---

## Rollback

### Rollback Cloud Run deployment
```bash
gcloud run services update-traffic inventory-backend \
  --to-revisions=PREVIOUS_REVISION=100
```

### Rollback Firebase Hosting
```bash
firebase hosting:rollback
```

---

## CI/CD with Cloud Build

Create `.github/workflows/deploy.yml` for automatic deployments:

```yaml
name: Deploy to GCP
on:
  push:
    branches: [main]

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v2
      - uses: google-github-actions/setup-gcloud@v0
        with:
          project_id: ${{ secrets.GCP_PROJECT_ID }}
          service_account_key: ${{ secrets.GCP_SA_KEY }}
      - run: gcloud builds submit --config backend/cloudbuild.yaml
```

---

## Support

- GCP Documentation: https://cloud.google.com/docs
- Firebase Documentation: https://firebase.google.com/docs
- Cloud Run: https://cloud.google.com/run/docs
- Firestore: https://cloud.google.com/firestore/docs
